<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=375, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The X Chase - Phone Asset Generator (V7, 완전수정!)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- 폰트 및 아이콘 항상 최상단 import -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', Apple SD Gothic Neo, Arial, Segoe UI, sans-serif;
        }
        .phone-scroll::-webkit-scrollbar { width: 4px; }
        .phone-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px;}
        .bubble-me-v7{
            background-color: var(--bubble-me-color, #FEE500);
            border-radius: 12px 0 12px 12px;
            padding: 10px 14px;
            font-size: 15px;
            line-height:1.4;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            max-width: 100%;
            word-break: break-all;
            display: inline-block;
        }
        .bubble-other-v7{
            background-color: var(--bubble-other-color, #fff);
            border-radius: 0 12px 12px 12px;
            padding: 10px 14px;
            font-size: 15px;
            line-height:1.4;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            max-width: 100%;
            word-break: break-all;
            display: inline-block;
        }
        .profile-img-fit { width: 40px; height: 40px; object-fit: cover; border-radius: 16px;}
        #preview-wrapper {
            width: 375px;
            height: 667px;
            transform-origin: top center;
            transition: transform 0.2s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
            background: #fff;
        }
        #custom-message-box {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            color: #333;
            background: rgba(255,255,255,0.96);
            border-radius: 999px;
            border: 1px solid #d6dee6;
            padding: 12px 32px;
            font-weight: 500;
            box-shadow: 0 3px 16px 0 rgba(0,0,0,0.07);
            opacity: 0;
            pointer-events: none;
            font-size:15px;
            z-index:999;
            transition: opacity 0.44s cubic-bezier(.45,1,.55,.92);
        }
        /* 프로필 X표 대체용 스타일까지 */
        .profile-no-img {
            width: 40px; height: 40px; border-radius:16px;
            display:flex;align-items:center;justify-content:center;
            background: #d6dee6;
        }
        .profile-no-img i{
            color: #777; font-size: 26px;line-height:1;
            display:block; width:100%;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden" onload="initApp()">

    <header class="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md shrink-0 z-50">
        <h1 class="text-xl font-bold"><i class="fas fa-mobile-alt mr-2"></i>The X Chase 에셋 생성기 (V7, 완전수정)</h1>
        <button onclick="downloadImage()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow transition flex items-center">
            <i class="fas fa-download mr-2"></i>이미지로 저장
        </button>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Left Panel: Controls -->
        <div class="w-1/3 bg-white p-6 overflow-y-auto border-r border-gray-200 shadow-lg z-20">
            <div class="flex space-x-2 mb-6 bg-gray-100 p-1 rounded-lg">
                <button onclick="setMode('messenger')" id="btn-messenger" class="flex-1 py-2 rounded-md font-bold text-sm bg-white shadow text-gray-800 transition">메신저</button>
                <button onclick="setMode('call')" id="btn-call" class="flex-1 py-2 rounded-md font-bold text-sm text-gray-500 hover:bg-white transition">통화 기록</button>
                <button onclick="setMode('memo')" id="btn-memo" class="flex-1 py-2 rounded-md font-bold text-sm text-gray-500 hover:bg-white transition">메모장</button>
            </div>
            <!-- Controls: Messenger -->
            <div id="controls-messenger" class="space-y-4">
                <h3 class="font-bold text-lg border-b pb-2">메시지 설정</h3>
                <div class="bg-gray-50 p-3 rounded-md border">
                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">상대방 프로필</label>
                    <div class="mb-2">
                        <label class="block text-sm font-medium text-gray-700">이름</label>
                        <input type="text" id="msg-name" value="김도준" oninput="renderContent()" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">프로필 사진</label>
                        <input type="file" id="msg-profile-upload" accept="image/*" onchange="handleProfileUpload(this)" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded-md border flex gap-4 items-center mt-2">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">버블 색상</label>
                        <div class="flex gap-2 items-center text-xs">
                            <span>상대방</span>
                            <input type="color" id="bubble-other-color" value="#ffffff" style="width: 32px;" oninput="updateBubbleColor()">
                            <span>나</span>
                            <input type="color" id="bubble-me-color" value="#fee500" style="width: 32px;" oninput="updateBubbleColor()">
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-4 bg-gray-50 p-3 rounded-lg">
                    <span class="text-sm font-bold">발신자:</span>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="sender" value="other" checked onchange="renderContent()" class="form-radio text-yellow-500 focus:ring-yellow-500">
                        <span class="ml-2 text-sm">상대방</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="sender" value="me" onchange="renderContent()" class="form-radio text-yellow-500 focus:ring-yellow-500">
                        <span class="ml-2 text-sm">나</span>
                    </label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">시간</label>
                    <input type="text" id="msg-time" value="오후 9:30" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">내용</label>
                    <textarea id="msg-text" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="내용을 입력하세요"></textarea>
                </div>
                <button onclick="addMessage()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-md transition shadow">메시지 추가</button>
                <button onclick="clearMessages()" class="w-full bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 rounded-md transition mt-2">초기화</button>
            </div>
            <!-- Controls: Call Log (Hidden) -->
            <div id="controls-call" class="hidden space-y-4">
                <h3 class="font-bold text-lg border-b pb-2">통화 기록 설정</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700">이름 / 번호</label>
                    <input type="text" id="call-name" value="정세연" oninput="renderContent()" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">유형</label>
                    <select id="call-type" onchange="renderContent()" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                        <option value="missed">부재중 전화 (빨강)</option>
                        <option value="incoming">수신됨/발신됨 (검정)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">날짜 / 시간</label>
                    <input type="text" id="call-time" value="어제" oninput="renderContent()" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">라벨</label>
                    <input type="text" id="call-label" value="휴대전화" oninput="renderContent()" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-gray-500">
                </div>
                <button onclick="addCallLog()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-md transition shadow">기록 추가</button>
                <button onclick="clearCallLogs()" class="w-full bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 rounded-md transition mt-2">초기화</button>
            </div>
            <!-- Controls: Memo (Hidden) -->
            <div id="controls-memo" class="space-y-4 hidden">
                <h3 class="font-bold text-lg border-b pb-2">메모장 설정</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700">제목</label>
                    <input type="text" id="memo-title" value="가계부" oninput="renderContent()" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">작성 날짜</label>
                    <input type="text" id="memo-date" value="2025년 5월 15일 오후 4:20" oninput="renderContent()" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">내용</label>
                    <textarea id="memo-content" rows="10" oninput="renderContent()" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="메모 내용">5/1 세연 - 디올 립스틱
5/10 세연 - 구찌 가방
5/15 도준 - 합의금...</textarea>
                </div>
            </div>
        </div>
        <!-- Right Panel: Preview Area -->
        <div id="preview-container" class="w-2/3 bg-gray-200 flex flex-col items-center justify-start pt-10 overflow-hidden relative">
            <div id="preview-wrapper">
                <div id="preview-content" class="w-full h-full bg-white relative phone-scroll overflow-y-auto"></div>
            </div>
            <div class="mt-4 text-gray-500 text-sm font-medium bg-white/50 px-3 py-1 rounded-full backdrop-blur-sm shadow-sm z-10">
                * 화면에 맞춰 자동 조절됨 (375pt 비율 유지)
            </div>
            <div id="custom-message-box"><span id="custom-message-text"></span></div>
        </div>
    </div>
    <script>
        let currentMode = 'messenger';
        let messages = [], callLogs = [];
        let otherProfilePic = null;

        function initApp() {
            renderContent(); fitScreen(); updateBubbleColor(); hideCustomMessage();
        }
        function fitScreen() {
            const container = document.getElementById('preview-container');
            const wrapper = document.getElementById('preview-wrapper');
            const margin = 60, originalHeight = 667;
            const availableHeight = container.clientHeight - margin;
            let scale = availableHeight / originalHeight;
            if(scale > 1) scale = 1;
            wrapper.style.transform = `scale(${scale})`;
        }
        function setMode(mode) {
            currentMode = mode;
            ['messenger','call','memo'].forEach(m=>{
                let btn=document.getElementById(`btn-${m}`);
                let controls=document.getElementById(`controls-${m}`);
                if(m===mode){btn.classList.remove('text-gray-500','hover:bg-white');btn.classList.add('bg-white','shadow','text-gray-800');controls.classList.remove('hidden');}
                else{btn.classList.add('text-gray-500','hover:bg-white');btn.classList.remove('bg-white','shadow','text-gray-800');controls.classList.add('hidden');}
            });
            renderContent();
        }
        function updateBubbleColor() {
            document.documentElement.style.setProperty('--bubble-me-color', document.getElementById('bubble-me-color').value);
            document.documentElement.style.setProperty('--bubble-other-color', document.getElementById('bubble-other-color').value);
            renderContent();
        }
        function renderContent() {
            const contentHTML = generateHTML();
            const previewElement = document.getElementById('preview-content');
            previewElement.className = (currentMode==='messenger'?"w-full h-full pt-4 pb-4 bg-[#bacee0] flex flex-col px-3":currentMode==='call'?"w-full h-full pt-10 bg-white":"w-full h-full pt-12 bg-[#fdfbf7] px-6")+" phone-scroll overflow-y-auto";
            previewElement.innerHTML = contentHTML;
            if (currentMode === 'messenger') { previewElement.scrollTop = previewElement.scrollHeight; }
        }
        function generateHTML() {
            if(currentMode==='messenger')return generateMessengerHTML();
            if(currentMode==='call')return generateCallLogHTML();
            if(currentMode==='memo')return generateMemoHTML();
            return '';
        }
        function generateMessengerHTML() {
            const otherName = document.getElementById('msg-name').value || "대화 상대";
            let html = '';
            messages.forEach((msg, idx) => {
                let profileHtml;
                // 프로필 이미지 렌더
                if (otherProfilePic) {
                    profileHtml = `<img src="${otherProfilePic}" alt="profile" class="profile-img-fit" onerror="this.onerror=null;this.style.display='none';this.parentNode.innerHTML='<div class=&quot;profile-no-img&quot;><i class=&quot;fas fa-user&quot;></i></div>';">`;
                } else {
                    profileHtml = `<div class="profile-no-img"><i class="fas fa-user"></i></div>`;
                }
                const bubbleText = msg.text.replace(/\n/g, '<br>');
                if (msg.type === 'other') {
                    html += `
                    <div class="flex w-full mb-3 items-start justify-start group hover:bg-gray-50">
                        <div class="mr-2 shrink-0" style="width:40px;height:40px;">
                            ${profileHtml}
                        </div>
                        <div class="flex flex-col items-start" style="max-width:75%;">
                            <div class="text-[13px] text-gray-600 mb-1 ml-1 leading-none">${otherName}</div>
                            <div class="flex items-end">
                                <div class="bubble-other-v7">${bubbleText}</div>
                                <span class="text-[10px] text-gray-500 ml-1.5 mb-0 min-w-[30px] whitespace-nowrap">${msg.time}</span>
                                <button onclick="removeMessage(${idx})" title="삭제" class="ml-1.5 px-2 py-1 opacity-40 group-hover:opacity-100 text-red-400"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    `;
                } else {
                    html += `
                    <div class="flex w-full mb-3 items-end justify-end group hover:bg-gray-50">
                        <div class="flex items-end justify-end" style="max-width:85%;">
                            <span class="text-[10px] text-gray-500 mr-1.5 mb-0 text-right min-w-[30px] whitespace-nowrap">${msg.time}</span>
                            <div class="bubble-me-v7">${bubbleText}</div>
                            <button onclick="removeMessage(${idx})" title="삭제" class="ml-1.5 px-2 py-1 opacity-40 group-hover:opacity-100 text-red-400"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    `;
                }
            });
            return html;
        }
        function generateCallLogHTML() {
            let html =
`<div class="px-5 pt-4 pb-2 text-[32px] font-bold text-black bg-white" style="position: sticky; top: 0; z-index: 10;">최근 통화</div>
<div class="px-5 pb-2 text-sm font-semibold text-gray-800 bg-white border-b border-gray-200 flex space-x-6" style="position: sticky; top: 60px; z-index: 10;">
    <span class="border-b-2 border-black pb-2">전체</span>
</div>
<div class="pl-5">`;
            callLogs.forEach((log, idx) => {
                const isMissed = log.type === 'missed';
                const textColor = isMissed ? 'text-[#ff3b30]' : 'text-black';
                const icon = isMissed ? '<i class="fas fa-phone-slash mr-3 text-sm text-gray-400"></i>' : '<i class="fas fa-phone mr-3 text-sm text-gray-400"></i>';
                html += `
                    <div class="flex items-center py-3 pr-4 border-b border-gray-100 bg-white min-h-[60px] group hover:bg-gray-50">
                        <div class="flex-1 min-w-0 flex items-center">
                            ${icon}
                            <div class="truncate">
                                <div class="font-bold ${textColor} text-[17px] leading-tight truncate">${log.name}</div>
                                <div class="text-[13px] text-gray-500 mt-0.5 truncate">${log.label}</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 shrink-0 ml-2">
                            <span class="text-[15px] text-gray-400 font-normal">${log.time}</span>
                            <i class="far fa-user-circle text-blue-500 text-xl ml-2"></i>
                            <button onclick="removeCallLog(${idx})" title="삭제" class="ml-2 px-2 py-1 opacity-40 group-hover:opacity-100 text-red-400"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }
        function generateMemoHTML() {
            const title = document.getElementById('memo-title').value;
            const date = document.getElementById('memo-date').value;
            const content = document.getElementById('memo-content').value;
            return `
                <div class="flex justify-between items-center mb-6 mt-2 px-1">
                    <div class="text-[#e0a826] font-bold text-lg flex items-center"><i class="fas fa-chevron-left mr-1 text-base"></i> 메모</div>
                    <div class="text-[#e0a826] font-bold text-lg">완료</div>
                </div>
                <h1 class="text-[30px] font-bold text-gray-900 mb-2 leading-tight tracking-tight">${title}</h1>
                <div class="text-gray-400 text-[13px] mb-6 font-medium">${date}</div>
                <div class="text-gray-800 text-[17px] leading-relaxed whitespace-pre-wrap font-normal">${content}</div>
            `;
        }
        function handleProfileUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    otherProfilePic = e.target.result;
                    renderContent();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function addMessage() {
            const text = document.getElementById('msg-text').value;
            const time = document.getElementById('msg-time').value;
            const senderType = document.querySelector('input[name="sender"]:checked').value;
            if(!text){showCustomMessage("내용을 입력하세요.");return;}
            if(messages.length >= 50){showCustomMessage("최대 50개까지 입력할 수 있습니다.");return;}
            messages.push({ text, time, type: senderType });
            renderContent(); document.getElementById('msg-text').value = '';
        }
        function removeMessage(idx) { messages.splice(idx, 1); renderContent(); }
        function clearMessages() {
            if(messages.length === 0){showCustomMessage("삭제할 메시지가 없습니다.");return;}
            messages = []; renderContent(); showCustomMessage("초기화 완료!");
        }
        function addCallLog() {
            const name = document.getElementById('call-name').value;
            const type = document.getElementById('call-type').value;
            const time = document.getElementById('call-time').value;
            const label = document.getElementById('call-label').value;
            if(!name){showCustomMessage("이름을 입력하세요.");return;}
            callLogs.push({ name, type, time, label });
            renderContent(); showCustomMessage("기록이 추가되었습니다.");
        }
        function removeCallLog(idx) { callLogs.splice(idx, 1); renderContent(); }
        function clearCallLogs() {
            if(callLogs.length === 0){showCustomMessage("삭제할 기록이 없습니다.");return;}
            callLogs = []; renderContent(); showCustomMessage("초기화 완료!");
        }
        function showCustomMessage(message) {
            let box = document.getElementById('custom-message-box'); document.getElementById('custom-message-text').textContent = message;
            box.style.opacity = '1'; box.style.pointerEvents = 'auto'; setTimeout(hideCustomMessage, 1800);
        }
        function hideCustomMessage() {
            let box = document.getElementById('custom-message-box');
            box.style.opacity = '0'; box.style.pointerEvents = 'none';
        }
        // 이미지 저장 반드시 preview-wrapper 대상 full사이즈
        async function downloadImage() {
            const wrapper = document.getElementById('preview-wrapper');
            const previewContent = document.getElementById('preview-content');
            const style = window.getComputedStyle(wrapper);
            const transform = style.getPropertyValue('transform');
            let currentScale = 1;
            if (transform && transform !== 'none') {
                const matrix = transform.match(/matrix.*\((.+)\)/);
                if (matrix && matrix[1]) {
                    const values = matrix[1].split(', ');
                    currentScale = parseFloat(values[0]);
                }
            }
            const originalOverflow = previewContent.style.overflowY;
            const originalWrapperHeight = wrapper.style.height;
            const originalWrapperTransform = wrapper.style.transform;
            const actualContentHeight = previewContent.scrollHeight;
            try {
                wrapper.style.height = `${actualContentHeight / currentScale}px`;
                previewContent.style.overflowY = 'hidden';
                const finalScale = 2 / currentScale;
                // 캡처시 배경 반드시 white, useCORS
                const canvas = await html2canvas(wrapper, {
                    scale: finalScale,
                    useCORS:true,
                    backgroundColor: "#fff",
                    width: wrapper.offsetWidth,
                    height: wrapper.offsetHeight,
                });
                const link = document.createElement('a');
                link.download = `x_chase_asset_${currentMode}_v7.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showCustomMessage("이미지 저장 완료!");
            } catch (error) {
                console.error("이미지 저장 오류:", error);
                showCustomMessage("이미지 저장 실패!");
            } finally {
                previewContent.style.overflowY = originalOverflow;
                wrapper.style.height = originalWrapperHeight;
                wrapper.style.transform = originalWrapperTransform;
            }
        }
        window.addEventListener("resize", fitScreen);
    </script>
</body>
</html>
